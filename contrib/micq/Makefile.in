@SET_MAKE@
BUILDTOP        = @BUILDTOP@
SRCTOP          = @SRCTOP@
PREFIX          = @prefix@
SRCDIR          = @srcdir@
VPATH           = @srcdir@
OZENGINE        = @ozengine@
PLATFORM        = @PLATFORM@
HOMEURL         = @HOMEURL@
LIB_DIR         = $(PREFIX)/contrib/micq
DEMO_DIR        = $(PREFIX)/doc/demo/applets
OZC             = @OZC@
COMPILE         = $(OZC) -b $(BUILDTOP)/contrib/micq/
OZL             = @OZL@
INSTALL         = @INSTALL@
INSTALL_DIR     = @INSTALL_DIR@
INSTALL_LIB     = $(INSTALL) -m 444
APPLETS         = server.oza client.oza
GIFCONV         = Gif2Functor.oza
ICONDIR         = $(SRCDIR)/Icons2
MAKEGIF         = $(OZENGINE) $(GIFCONV)
GIFS            = $(addsuffix _gif.ozf, Logo Letter Online Offline Away Powered_by_oz Eyes)

all:            $(GIFCONV) $(GIFS) $(APPLETS)

install:: $(LIB_DIR) $(DEMO_DIR) \
        $(addprefix $(LIB_DIR)/,$(APPLETS)) \
        $(DEMO_DIR)/MIM.oza

$(LIB_DIR) $(DEMO_DIR):
        $(INSTALL_DIR) $@
$(LIB_DIR)/%.oza: %.oza
        $(INSTALL_LIB) $< $@
$(DEMO_DIR)/MIM.oza: client.oza
        $(INSTALL_LIB) $< $@
BMETH = $(BUILDTOP)/contrib/micq/methods.ozf
SMETH = $(SRCDIR)/methods.oz


$(GIFCONV) : Gif2Functor.oz GifToBase64.ozf
        $(COMPILE) -x $< -o $@

GifToBase64.ozf : GifToBase64.oz
        $(COMPILE) -c $< -o $@

Logo_gif.ozf : $(ICONDIR)/logo.gif
        $(MAKEGIF) $(ICONDIR)/logo.gif -o Logo_gif.ozf

Letter_gif.ozf : $(ICONDIR)/letter.gif
        $(MAKEGIF) $(ICONDIR)/letter.gif -o Letter_gif.ozf

Away_gif.ozf : $(ICONDIR)/away_t.gif
        $(MAKEGIF) $(ICONDIR)/away_t.gif -o Away_gif.ozf

Online_gif.ozf : $(ICONDIR)/online_t.gif
        $(MAKEGIF) $(ICONDIR)/online_t.gif -o Online_gif.ozf

Offline_gif.ozf : $(ICONDIR)/offline_t.gif
        $(MAKEGIF) $(ICONDIR)/offline_t.gif -o Offline_gif.ozf

Eyes_gif.ozf : $(ICONDIR)/eyes_t.gif
        $(MAKEGIF) $(ICONDIR)/eyes_t.gif -o Eyes_gif.ozf

Powered_by_oz_gif.ozf : $(ICONDIR)/powered-by-oz-100.gif
        $(MAKEGIF) $(ICONDIR)/powered-by-oz-100.gif -o Powered_by_oz_gif.ozf

server.oza: micq
        $(OZL) -z 9 $< -o $@
client.oza: client
        $(OZL) -z 9 $< -o $@

micq: startserver.oz server.ozf
        $(COMPILE) -x $< -o $@

client: startclient.oz client.ozf
        $(COMPILE) -x $< -o $@

%.ozf: %.oz
        $(COMPILE) -c $< -o $@

server.ozf: server.oz $(BMETH) defaultsettings.ozf database.ozf mobility.ozf newaccountgui.ozf \
        log.ozf  sysadm.ozf
        $(COMPILE) -c $< -o $@

FaqEdit.ozf : FaqEdit.oz
        $(COMPILE) -c  $< -o $@

ScrollFrame.ozf : ScrollFrame.oz
        $(COMPILE) -c  $< -o $@

MozartPower.ozf : MozartPower.oz Powered_by_oz_gif.ozf
        $(COMPILE) -c $< -o $@

addapplicationgui.ozf: addapplicationgui.oz $(BMETH)
        $(COMPILE) -c $< -o $@
editapplicationgui.ozf: editapplicationgui.oz $(BMETH)
        $(COMPILE) -c $< -o $@
editaccount.ozf: editaccount.oz $(BMETH)
        $(COMPILE) -c $< -o $@
newaccountgui.ozf: newaccountgui.oz $(BMETH)
        $(COMPILE) -c $< -o $@
newfriendsgui.ozf: newfriendsgui.oz $(BMETH)
        $(COMPILE) -c $< -o $@
sysadm.ozf: sysadm.oz $(BMETH) addapplicationgui.ozf editapplicationgui.ozf
        $(COMPILE) -c $< -o $@
client.ozf : client.oz $(BMETH) clientgui.ozf newfriendsgui.ozf \
        defaultsettings.ozf dialoggui.ozf mobility.ozf FaqEdit.ozf
        $(COMPILE) -c $< -o $@
clientgui.ozf : clientgui.oz $(BMETH) messagedisplay.ozf manager.ozf \
        defaultsettings.ozf popup.ozf messagegui.ozf editaccount.ozf \
        draganddrop.ozf addapplicationgui.ozf configureclient.ozf \
        editapplicationgui.ozf ScrollFrame.ozf MozartPower.ozf
        $(COMPILE) -c $< -o $@
messagegui.ozf : messagegui.oz BrowserControl.ozf popup.ozf
        $(COMPILE) -c $< -o $@
BrowserControl.ozf : BrowserControl.oz
        $(COMPILE) -c $< -o $@

$(BMETH): methods.ozf.orig
          cp $< $@

clean veryclean:
        -rm -f *~ *.ozf *.oza micq client

distclean: veryclean
        -rm -f Makefile config.*

include $(SRCTOP)/share/Makefile.boot

bootstrap: boot-all

newboot:
        $(COMPILE) -c $(SMETH) -o $(SMETH)f.orig

#---------------------------------------------------------------------
# Automatic Makefile update
#---------------------------------------------------------------------

Makefile: Makefile.in config.status
        ./config.status

config.status: configure
        ./config.status --recheck
