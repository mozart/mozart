BUILDTOP	= @BUILDTOP@
prefix		= @prefix@
PLATFORM	= @PLATFORM@
PACKAGE		= @PACKAGE@
PROTOCOL	= @PROTOCOL@
DIR_LOAD	= $(prefix)/cache/$(PROTOCOL)/$(PACKAGE)
DIR_DLOAD	= $(prefix)/platform/$(PLATFORM)/cache/$(PACKAGE)

OZC		= @OZC@
COMPILE		= $(OZC) -c
#COMPILE		= $(OZC) -l Standard -c
OZDYNLD		= @OZDYNLD@
MKINSTALLDIRS	= @MKINSTALLDIRS@

CXX		= @CXX@
CPPFLAGS	= -I../../platform/emulator @CPPFLAGS@
CXXFLAGS	= $(CFLAGS)
LDFLAGS		= @LDFLAGS@
LIBS		= @LIBS@

INSTALL		= @INSTALL@
INSTALL_DIR	= $(MKINSTALLDIRS)
INSTALL_BIN	= $(INSTALL) -m 555
INSTALL_LIB	= $(INSTALL) -m 444

FILES_LOAD	= gdbm.ozf
FILES_DLOAD	= gdbm.so

LIB_FILES_LOAD	= $(addprefix $(DIR_LOAD)/,$(FILES_LOAD))
LIB_FILES_DLOAD	= $(addprefix $(DIR_DLOAD)/,$(FILES_DLOAD))

.PHONY: all install install-load install-dload \
	clean veryclean distclean bootstrap

all: gdbm.so gdbm.ozf
bootstrap: all

install: install-load install-dload
install-load:	$(DIR_LOAD)  $(LIB_FILES_LOAD)
install-dload:	$(DIR_DLOAD) $(LIB_FILES_DLOAD)

$(DIR_LOAD) $(DIR_DLOAD):
	$(INSTALL_DIR) $@

$(subst %,\%,$(DIR_LOAD))/%: %
	$(INSTALL_LIB) $< $@

$(subst %,\%,$(DIR_DLOAD))/%: %
	$(INSTALL_LIB) $< $@

gdbm.o: gdbm.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $<

gdbm.so: gdbm.o
	$(OZDYNLD) -o gdbm.so gdbm.o $(LDFLAGS) $(LIBS)

gdbm.ozf: gdbm.oz
	$(COMPILE) gdbm.oz -o gdbm.ozf

clean veryclean:
	-$(RM) *~ *.bak *.o *.so *.ozf

distclean: clean
	-$(RM) config.* Makefile gdbm.oz

include ../../share/Makefile.boot
